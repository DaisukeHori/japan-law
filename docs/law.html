<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ³•ä»¤ãƒ“ãƒ¥ãƒ¼ã‚¢ - æ—¥æœ¬æ³•ä»¤ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <style>
    .law-content h1 { font-size: 1.5rem; font-weight: bold; margin: 1.5rem 0 1rem; border-bottom: 2px solid #e5e7eb; padding-bottom: 0.5rem; }
    .law-content h2 { font-size: 1.25rem; font-weight: bold; margin: 1.25rem 0 0.75rem; color: #1e40af; }
    .law-content h3 { font-size: 1.1rem; font-weight: 600; margin: 1rem 0 0.5rem; }
    .law-content h4 { font-size: 1rem; font-weight: 600; margin: 0.75rem 0 0.5rem; color: #4b5563; }
    .law-content p { margin: 0.5rem 0; line-height: 1.8; }
    .law-content ul, .law-content ol { margin: 0.5rem 0 0.5rem 1.5rem; }
    .law-content li { margin: 0.25rem 0; }
    .law-content table { border-collapse: collapse; margin: 1rem 0; width: 100%; }
    .law-content th, .law-content td { border: 1px solid #e5e7eb; padding: 0.5rem; text-align: left; }
    .law-content th { background: #f3f4f6; }
    .law-content blockquote { border-left: 4px solid #e5e7eb; padding-left: 1rem; margin: 1rem 0; color: #6b7280; }
    .law-content hr { margin: 2rem 0; border-color: #e5e7eb; }
  </style>
</head>
<body class="bg-gray-50 min-h-screen">
  <header class="bg-blue-900 text-white py-4">
    <div class="max-w-4xl mx-auto px-4">
      <nav class="text-blue-200 text-sm mb-2">
        <a href="./" class="hover:underline">ãƒ›ãƒ¼ãƒ </a> &gt;
        <a href="./search.html" class="hover:underline">æ¤œç´¢</a> &gt;
        <span id="breadcrumb-title">æ³•ä»¤</span>
      </nav>
      <h1 class="text-2xl font-bold" id="law-title">èª­ã¿è¾¼ã¿ä¸­...</h1>
    </div>
  </header>

  <main class="max-w-4xl mx-auto px-4 py-6">
    <!-- ãƒ¡ã‚¿æƒ…å ± -->
    <section id="meta-section" class="bg-white rounded-lg shadow-md p-4 mb-6 hidden">
      <div class="flex flex-wrap gap-4 text-sm">
        <div>
          <span class="text-gray-500">æ³•ä»¤ç•ªå·:</span>
          <span id="law-num" class="font-medium ml-1">-</span>
        </div>
        <div>
          <span class="text-gray-500">ã‚«ãƒ†ã‚´ãƒª:</span>
          <span id="law-category" class="font-medium ml-1">-</span>
        </div>
        <div>
          <a id="github-link" href="#" target="_blank" class="text-blue-600 hover:underline">
            GitHub ã§è¦‹ã‚‹ â†’
          </a>
        </div>
        <div>
          <a id="xml-link" href="#" target="_blank" class="text-blue-600 hover:underline">
            XML (åŸæœ¬) â†’
          </a>
        </div>
      </div>
    </section>

    <!-- æœ¬æ–‡ -->
    <section class="bg-white rounded-lg shadow-md p-6">
      <div id="loading" class="text-center py-8">
        <div class="animate-spin inline-block w-8 h-8 border-4 border-blue-500 border-t-transparent rounded-full"></div>
        <p class="mt-4 text-gray-600">èª­ã¿è¾¼ã¿ä¸­...</p>
      </div>
      <div id="error" class="hidden text-center py-8 text-red-600">
        <p class="text-lg">æ³•ä»¤ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</p>
        <p class="text-sm mt-2" id="error-detail"></p>
      </div>
      <article id="content" class="law-content hidden"></article>
    </section>

    <!-- å‚ç…§æƒ…å ± -->
    <section id="references-section" class="bg-white rounded-lg shadow-md p-6 mt-6 hidden">
      <h2 class="text-lg font-bold mb-4">ğŸ”— å‚ç…§é–¢ä¿‚</h2>
      <div class="grid md:grid-cols-2 gap-6">
        <div>
          <h3 class="font-semibold text-green-700 mb-2">ã“ã®æ³•ä»¤ãŒå‚ç…§ã—ã¦ã„ã‚‹æ³•ä»¤</h3>
          <ul id="outgoing-refs" class="text-sm space-y-1 max-h-48 overflow-y-auto"></ul>
        </div>
        <div>
          <h3 class="font-semibold text-blue-700 mb-2">ã“ã®æ³•ä»¤ã‚’å‚ç…§ã—ã¦ã„ã‚‹æ³•ä»¤</h3>
          <ul id="incoming-refs" class="text-sm space-y-1 max-h-48 overflow-y-auto"></ul>
        </div>
      </div>
    </section>
  </main>

  <footer class="bg-gray-800 text-gray-400 py-6 mt-8">
    <div class="max-w-4xl mx-auto px-4 text-center">
      <p>Â© 2025 Japan Law Database Project</p>
    </div>
  </footer>

  <script>
    const categoryNames = {
      constitution: "æ†²æ³•",
      acts: "æ³•å¾‹",
      cabinet_orders: "æ”¿ä»¤",
      imperial_orders: "å‹…ä»¤",
      ministerial_ordinances: "åºœçœä»¤",
      rules: "è¦å‰‡",
      misc: "ãã®ä»–"
    };

    async function loadLaw() {
      const params = new URLSearchParams(window.location.search);
      const lawId = params.get('id');
      const category = params.get('category') || 'acts';

      if (!lawId) {
        showError('æ³•ä»¤IDãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“');
        return;
      }

      try {
        // Markdown ã‚’å–å¾—
        const mdPath = `./data/markdown/${category}/${lawId}.md`;
        const response = await fetch(mdPath);

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }

        const markdown = await response.text();

        // ã‚¿ã‚¤ãƒˆãƒ«æŠ½å‡ºï¼ˆæœ€åˆã® # è¡Œï¼‰
        const titleMatch = markdown.match(/^#\s+(.+)$/m);
        const title = titleMatch ? titleMatch[1] : lawId;

        document.getElementById('law-title').textContent = title;
        document.getElementById('breadcrumb-title').textContent = title.slice(0, 30) + (title.length > 30 ? '...' : '');
        document.title = `${title} - æ—¥æœ¬æ³•ä»¤ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹`;

        // ãƒ¡ã‚¿æƒ…å ±
        document.getElementById('law-category').textContent = categoryNames[category] || category;
        document.getElementById('github-link').href = `https://github.com/DaisukeHori/japan-law/blob/main/data/markdown/${category}/${lawId}.md`;
        document.getElementById('xml-link').href = `https://github.com/DaisukeHori/japan-law/blob/main/data/xml/${category}/${lawId}.xml`;

        // æ³•ä»¤ç•ªå·ã‚’æŠ½å‡ºï¼ˆ2è¡Œç›®ã‚ãŸã‚Šã«ã‚ã‚‹ï¼‰
        const numMatch = markdown.match(/^>\s*(.+)$/m);
        if (numMatch) {
          document.getElementById('law-num').textContent = numMatch[1];
        }

        document.getElementById('meta-section').classList.remove('hidden');

        // Markdown ã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
        const html = marked.parse(markdown);
        document.getElementById('content').innerHTML = html;
        document.getElementById('content').classList.remove('hidden');
        document.getElementById('loading').classList.add('hidden');

        // ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³å†…ã®ãƒªãƒ³ã‚¯ã‚’é©åˆ‡ãªURLã«å¤‰æ›
        convertMarkdownLinks();

        // å‚ç…§æƒ…å ±ã‚’èª­ã¿è¾¼ã¿
        loadReferences(lawId);

      } catch (e) {
        showError(`æ³•ä»¤ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ${e.message}`);
      }
    }

    async function loadReferences(lawId) {
      try {
        // æ³•ä»¤ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’å…ˆã«èª­ã¿è¾¼ã‚“ã§ã‚«ãƒ†ã‚´ãƒªã‚’è§£æ±º
        const index = await loadLawIndex();

        const [refsRes, backlinksRes] = await Promise.all([
          fetch('../data/index/references.json'),
          fetch('../data/index/backlinks.json')
        ]);

        const refsData = await refsRes.json();
        const backlinksData = await backlinksRes.json();

        // ã‚«ãƒ†ã‚´ãƒªã‚’å–å¾—ã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
        const getCategory = (id) => {
          const law = index.get(id);
          return law?.category || 'acts';
        };

        // ã“ã®æ³•ä»¤ã‹ã‚‰ã®å‚ç…§
        const outgoing = (refsData.references || []).filter(r => r.from_law_id === lawId);
        const outgoingList = document.getElementById('outgoing-refs');

        if (outgoing.length > 0) {
          outgoingList.innerHTML = outgoing.slice(0, 20).map(r => {
            const category = getCategory(r.to_law_id);
            return `
            <li>
              <a href="law.html?id=${r.to_law_id}&category=${category}" class="text-green-600 hover:underline">
                â†’ ${r.to_law_title}
              </a>
            </li>
          `;
          }).join('');
          if (outgoing.length > 20) {
            outgoingList.innerHTML += `<li class="text-gray-500">...ä»– ${outgoing.length - 20} ä»¶</li>`;
          }
        } else {
          outgoingList.innerHTML = '<li class="text-gray-500">ãªã—</li>';
        }

        // ã“ã®æ³•ä»¤ã¸ã®å‚ç…§
        const incoming = backlinksData.backlinks?.[lawId]?.referenced_by || [];
        const incomingList = document.getElementById('incoming-refs');

        if (incoming.length > 0) {
          incomingList.innerHTML = incoming.slice(0, 20).map(r => {
            const category = getCategory(r.law_id);
            return `
            <li>
              <a href="law.html?id=${r.law_id}&category=${category}" class="text-blue-600 hover:underline">
                â† ${r.title}
              </a>
              <span class="text-gray-400 text-xs">(${r.count}å›)</span>
            </li>
          `;
          }).join('');
          if (incoming.length > 20) {
            incomingList.innerHTML += `<li class="text-gray-500">...ä»– ${incoming.length - 20} ä»¶</li>`;
          }
        } else {
          incomingList.innerHTML = '<li class="text-gray-500">ãªã—</li>';
        }

        document.getElementById('references-section').classList.remove('hidden');

      } catch (e) {
        console.error('Failed to load references:', e);
      }
    }

    function showError(message) {
      document.getElementById('loading').classList.add('hidden');
      document.getElementById('error').classList.remove('hidden');
      document.getElementById('error-detail').textContent = message;
      document.getElementById('law-title').textContent = 'ã‚¨ãƒ©ãƒ¼';
    }

    // æ³•ä»¤ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼ˆã‚«ãƒ†ã‚´ãƒªè§£æ±ºç”¨ï¼‰
    let lawIndex = null;

    async function loadLawIndex() {
      if (lawIndex) return lawIndex;
      try {
        const res = await fetch('../data/index/laws.json');
        const data = await res.json();
        lawIndex = new Map(data.laws.map(l => [l.id, l]));
        return lawIndex;
      } catch (e) {
        console.error('Failed to load law index:', e);
        return new Map();
      }
    }

    // ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³å†…ã® .md ãƒªãƒ³ã‚¯ã‚’ law.html?id=... å½¢å¼ã«å¤‰æ›
    function convertMarkdownLinks() {
      const content = document.getElementById('content');
      const links = content.querySelectorAll('a');

      links.forEach(link => {
        const href = link.getAttribute('href');
        if (!href) return;

        // .md ãƒ•ã‚¡ã‚¤ãƒ«ã¸ã®ãƒªãƒ³ã‚¯ã‚’å¤‰æ›
        // ãƒ‘ã‚¿ãƒ¼ãƒ³: ./ã‚«ãƒ†ã‚´ãƒª/æ³•ä»¤ID.md ã¾ãŸã¯ ../ã‚«ãƒ†ã‚´ãƒª/æ³•ä»¤ID.md ã¾ãŸã¯ æ³•ä»¤ID.md
        const mdMatch = href.match(/(?:\.\.?\/)?(?:([a-z_]+)\/)?([A-Z0-9]+)\.md(#.+)?$/);
        if (mdMatch) {
          const category = mdMatch[1] || 'acts';
          const lawId = mdMatch[2];
          const anchor = mdMatch[3] || '';
          link.setAttribute('href', `law.html?id=${lawId}&category=${category}${anchor}`);
          link.classList.add('text-blue-600', 'hover:underline');
        }

        // å†…éƒ¨ã‚¢ãƒ³ã‚«ãƒ¼ãƒªãƒ³ã‚¯ï¼ˆåŒä¸€æ³•ä»¤å†…ã®æ¡æ–‡å‚ç…§ï¼‰
        if (href.startsWith('#')) {
          link.classList.add('text-green-600', 'hover:underline');
        }
      });
    }

    loadLaw();
  </script>
</body>
</html>
