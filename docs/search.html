<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ³•ä»¤æ¤œç´¢ - æ—¥æœ¬æ³•ä»¤ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/fuse.js@7.0.0/dist/fuse.min.js"></script>
</head>
<body class="bg-gray-50 min-h-screen">
  <div id="app">
    <!-- Header -->
    <header class="bg-blue-900 text-white py-6">
      <div class="max-w-6xl mx-auto px-4">
        <nav class="text-blue-200 text-sm mb-2">
          <a href="./" class="hover:underline">ãƒ›ãƒ¼ãƒ </a> &gt; æ³•ä»¤æ¤œç´¢
        </nav>
        <h1 class="text-3xl font-bold">ğŸ“– æ³•ä»¤æ¤œç´¢</h1>
        <p class="text-blue-200 mt-1">ç´„9,000ä»¶ã®æ³•ä»¤ã‚’æ¤œç´¢ã§ãã¾ã™</p>
      </div>
    </header>

    <main class="max-w-6xl mx-auto px-4 py-8">
      <!-- æ¤œç´¢ãƒœãƒƒã‚¯ã‚¹ -->
      <section class="bg-white rounded-lg shadow-md p-6 mb-6">
        <div class="flex flex-col md:flex-row gap-4">
          <div class="flex-1">
            <input 
              type="text" 
              id="searchInput"
              placeholder="æ³•ä»¤åã€ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›..."
              class="w-full px-4 py-3 text-lg border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
              autofocus
            >
          </div>
          <div class="flex gap-2">
            <select id="categoryFilter" class="px-4 py-3 border border-gray-300 rounded-lg">
              <option value="">å…¨ã‚«ãƒ†ã‚´ãƒª</option>
              <option value="constitution">æ†²æ³•</option>
              <option value="acts">æ³•å¾‹</option>
              <option value="cabinet_orders">æ”¿ä»¤</option>
              <option value="imperial_orders">å‹…ä»¤</option>
              <option value="ministerial_ordinances">åºœçœä»¤</option>
              <option value="rules">è¦å‰‡</option>
              <option value="misc">ãã®ä»–</option>
            </select>
            <button 
              id="searchBtn"
              class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors"
            >
              æ¤œç´¢
            </button>
          </div>
        </div>
        <div class="mt-3 text-sm text-gray-500">
          <span id="totalCount">èª­ã¿è¾¼ã¿ä¸­...</span>
        </div>
      </section>

      <!-- æ¤œç´¢çµæœ -->
      <section id="results" class="space-y-4">
        <!-- åˆæœŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
        <div id="initialMessage" class="bg-white rounded-lg shadow-md p-8 text-center text-gray-500">
          <p class="text-lg mb-4">ğŸ” æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</p>
          <p class="text-sm">æ³•ä»¤åã‚„é–¢é€£ã™ã‚‹ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã§æ¤œç´¢ã§ãã¾ã™</p>
        </div>

        <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° -->
        <div id="loading" class="hidden bg-white rounded-lg shadow-md p-8 text-center">
          <div class="animate-spin inline-block w-8 h-8 border-4 border-blue-500 border-t-transparent rounded-full"></div>
          <p class="mt-4 text-gray-600">æ¤œç´¢ä¸­...</p>
        </div>

        <!-- çµæœãƒªã‚¹ãƒˆ -->
        <div id="resultList" class="hidden space-y-3"></div>

        <!-- çµæœãªã— -->
        <div id="noResults" class="hidden bg-white rounded-lg shadow-md p-8 text-center text-gray-500">
          <p class="text-lg">ğŸ˜• è©²å½“ã™ã‚‹æ³•ä»¤ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ</p>
          <p class="text-sm mt-2">åˆ¥ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã§æ¤œç´¢ã—ã¦ã¿ã¦ãã ã•ã„</p>
        </div>
      </section>

      <!-- ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ -->
      <section id="pagination" class="hidden mt-6 flex justify-center gap-2">
        <button id="prevBtn" class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300 disabled:opacity-50">å‰ã¸</button>
        <span id="pageInfo" class="px-4 py-2"></span>
        <button id="nextBtn" class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300 disabled:opacity-50">æ¬¡ã¸</button>
      </section>
    </main>

    <footer class="bg-gray-800 text-gray-400 py-6 mt-8">
      <div class="max-w-6xl mx-auto px-4 text-center">
        <p>Â© 2025 Japan Law Database Project</p>
        <p class="text-sm mt-2">
          æ³•ä»¤ãƒ‡ãƒ¼ã‚¿ã¯<a href="https://elaws.e-gov.go.jp/" class="text-blue-400 hover:underline">e-Govæ³•ä»¤æ¤œç´¢</a>ã‚ˆã‚Šå–å¾—
        </p>
      </div>
    </footer>
  </div>

  <script>
    // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
    let laws = [];
    let fuse = null;
    let currentResults = [];
    let currentPage = 1;
    const perPage = 20;

    // ã‚«ãƒ†ã‚´ãƒªåã®ãƒãƒƒãƒ”ãƒ³ã‚°
    const categoryNames = {
      constitution: "æ†²æ³•",
      acts: "æ³•å¾‹",
      cabinet_orders: "æ”¿ä»¤",
      imperial_orders: "å‹…ä»¤",
      ministerial_ordinances: "åºœçœä»¤",
      rules: "è¦å‰‡",
      misc: "ãã®ä»–",
    };

    // ã‚«ãƒ†ã‚´ãƒªã®è‰²
    const categoryColors = {
      constitution: "bg-purple-100 text-purple-800",
      acts: "bg-blue-100 text-blue-800",
      cabinet_orders: "bg-green-100 text-green-800",
      imperial_orders: "bg-yellow-100 text-yellow-800",
      ministerial_ordinances: "bg-orange-100 text-orange-800",
      rules: "bg-red-100 text-red-800",
      misc: "bg-gray-100 text-gray-800",
    };

    // åˆæœŸåŒ–
    async function init() {
      try {
        const response = await fetch("./data/index/laws.json");
        const data = await response.json();
        laws = data.laws || [];

        // Fuseã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä½œæˆ
        fuse = new Fuse(laws, {
          keys: ["title", "lawNum"],
          threshold: 0.3,
          includeScore: true,
          minMatchCharLength: 2,
        });

        document.getElementById("totalCount").textContent = `${laws.length.toLocaleString()} ä»¶ã®æ³•ä»¤`;

        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
        document.getElementById("searchInput").addEventListener("keypress", (e) => {
          if (e.key === "Enter") search();
        });
        document.getElementById("searchBtn").addEventListener("click", search);
        document.getElementById("categoryFilter").addEventListener("change", search);
        document.getElementById("prevBtn").addEventListener("click", () => changePage(-1));
        document.getElementById("nextBtn").addEventListener("click", () => changePage(1));

      } catch (error) {
        console.error("Failed to load laws:", error);
        document.getElementById("totalCount").textContent = "ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ";
      }
    }

    // æ¤œç´¢å®Ÿè¡Œ
    function search() {
      const query = document.getElementById("searchInput").value.trim();
      const category = document.getElementById("categoryFilter").value;

      // UIãƒªã‚»ãƒƒãƒˆ
      document.getElementById("initialMessage").classList.add("hidden");
      document.getElementById("noResults").classList.add("hidden");
      document.getElementById("resultList").classList.add("hidden");
      document.getElementById("pagination").classList.add("hidden");
      document.getElementById("loading").classList.remove("hidden");

      // å°‘ã—é…å»¶ã•ã›ã¦UIã‚’æ›´æ–°
      setTimeout(() => {
        let results;

        if (query) {
          // Fuseã§æ¤œç´¢
          results = fuse.search(query).map(r => r.item);
        } else {
          // ã‚¯ã‚¨ãƒªãªã—ã®å ´åˆã¯å…¨ä»¶
          results = [...laws];
        }

        // ã‚«ãƒ†ã‚´ãƒªãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
        if (category) {
          results = results.filter(law => law.category === category);
        }

        currentResults = results;
        currentPage = 1;

        document.getElementById("loading").classList.add("hidden");

        if (results.length === 0) {
          document.getElementById("noResults").classList.remove("hidden");
        } else {
          renderResults();
        }
      }, 100);
    }

    // çµæœã‚’æç”»
    function renderResults() {
      const resultList = document.getElementById("resultList");
      resultList.innerHTML = "";
      resultList.classList.remove("hidden");

      const start = (currentPage - 1) * perPage;
      const end = start + perPage;
      const pageResults = currentResults.slice(start, end);

      for (const law of pageResults) {
        const card = document.createElement("div");
        card.className = "bg-white rounded-lg shadow-md p-4 hover:shadow-lg transition-shadow cursor-pointer";
        card.innerHTML = `
          <div class="flex items-start justify-between">
            <div class="flex-1">
              <h3 class="text-lg font-semibold text-blue-800 hover:underline">${law.title}</h3>
              <p class="text-sm text-gray-600 mt-1">${law.lawNum}</p>
            </div>
            <span class="ml-4 px-2 py-1 text-xs rounded ${categoryColors[law.category] || categoryColors.misc}">
              ${categoryNames[law.category] || "ãã®ä»–"}
            </span>
          </div>
        `;

        card.addEventListener("click", () => {
          window.open(`./data/markdown/${law.category}/${law.id}.md`, "_blank");
        });

        resultList.appendChild(card);
      }

      // ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³
      const totalPages = Math.ceil(currentResults.length / perPage);
      if (totalPages > 1) {
        document.getElementById("pagination").classList.remove("hidden");
        document.getElementById("pageInfo").textContent = `${currentPage} / ${totalPages} ãƒšãƒ¼ã‚¸ï¼ˆ${currentResults.length} ä»¶ï¼‰`;
        document.getElementById("prevBtn").disabled = currentPage === 1;
        document.getElementById("nextBtn").disabled = currentPage === totalPages;
      } else {
        document.getElementById("pagination").classList.add("hidden");
      }
    }

    // ãƒšãƒ¼ã‚¸å¤‰æ›´
    function changePage(delta) {
      const totalPages = Math.ceil(currentResults.length / perPage);
      const newPage = currentPage + delta;

      if (newPage >= 1 && newPage <= totalPages) {
        currentPage = newPage;
        renderResults();
        window.scrollTo({ top: 0, behavior: "smooth" });
      }
    }

    // åˆæœŸåŒ–å®Ÿè¡Œ
    init();
  </script>
</body>
</html>
