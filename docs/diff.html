<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ³•ä»¤æ”¹æ­£å±¥æ­´ - æ—¥æœ¬æ³•ä»¤ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/diff2html@3.4.48/bundles/js/diff2html-ui.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/diff2html@3.4.48/bundles/css/diff2html.min.css">
  <style>
    .d2h-wrapper { font-size: 13px; }
    .d2h-file-header { background: #f1f5f9; }
    .d2h-code-line-ctn { white-space: pre-wrap; word-wrap: break-word; }
    .commit-card:hover { transform: translateY(-2px); }
  </style>
</head>
<body class="bg-gray-50 min-h-screen">
  <header class="bg-blue-900 text-white py-4">
    <div class="max-w-7xl mx-auto px-4">
      <div class="flex items-center justify-between">
        <div>
          <h1 class="text-2xl font-bold">ğŸ“œ æ³•ä»¤æ”¹æ­£å±¥æ­´</h1>
          <p class="text-blue-200 text-sm">Law Amendment History Viewer</p>
        </div>
        <a href="./" class="text-blue-200 hover:text-white">â† ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹</a>
      </div>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-4 py-6">
    <!-- èª¬æ˜ -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-6">
      <h2 class="text-lg font-bold mb-2">ğŸ’¡ æ³•ä»¤ã‚’ã‚³ãƒ¼ãƒ‰ã¨ã—ã¦ç®¡ç†</h2>
      <p class="text-gray-700 mb-4">
        ã“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ã¯ã€æ³•ä»¤ã‚’ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã®ã‚ˆã†ã« Git ã§ç®¡ç†ã—ã¦ã„ã¾ã™ã€‚
        æ³•ä»¤ã®æ”¹æ­£ã¯ Git ã®ã‚³ãƒŸãƒƒãƒˆå±¥æ­´ã¨ã—ã¦è¨˜éŒ²ã•ã‚Œã€å·®åˆ†ï¼ˆdiffï¼‰ã§å¤‰æ›´ç®‡æ‰€ã‚’ç¢ºèªã§ãã¾ã™ã€‚
      </p>
      <div class="grid md:grid-cols-4 gap-4 text-center text-sm">
        <div class="bg-blue-50 rounded-lg p-3">
          <div class="text-2xl mb-1">ğŸ“</div>
          <div class="font-semibold">Create</div>
          <div class="text-gray-600">æ–°è¦æ³•ä»¤ = git add</div>
        </div>
        <div class="bg-green-50 rounded-lg p-3">
          <div class="text-2xl mb-1">ğŸ“–</div>
          <div class="font-semibold">Read</div>
          <div class="text-gray-600">æ³•ä»¤é–²è¦§ = git show</div>
        </div>
        <div class="bg-yellow-50 rounded-lg p-3">
          <div class="text-2xl mb-1">âœï¸</div>
          <div class="font-semibold">Update</div>
          <div class="text-gray-600">æ³•ä»¤æ”¹æ­£ = git diff</div>
        </div>
        <div class="bg-red-50 rounded-lg p-3">
          <div class="text-2xl mb-1">ğŸ—‘ï¸</div>
          <div class="font-semibold">Delete</div>
          <div class="text-gray-600">æ³•ä»¤å»ƒæ­¢ = git rm</div>
        </div>
      </div>
    </div>

    <!-- æ³•ä»¤é¸æŠ -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-6">
      <h3 class="text-lg font-bold mb-4">ğŸ” æ³•ä»¤ã‚’é¸æŠ</h3>
      <div class="flex flex-col md:flex-row gap-4">
        <div class="flex-1">
          <input type="text" id="law-search" placeholder="æ³•ä»¤åã§æ¤œç´¢..."
                 class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
        </div>
        <button id="load-history-btn" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
          å±¥æ­´ã‚’è¡¨ç¤º
        </button>
      </div>
      <div id="law-suggestions" class="mt-2 max-h-48 overflow-y-auto hidden border rounded-lg"></div>
    </div>

    <!-- ã‚³ãƒŸãƒƒãƒˆå±¥æ­´ -->
    <div id="history-section" class="hidden">
      <div class="bg-white rounded-lg shadow-md p-6 mb-6">
        <h3 class="text-lg font-bold mb-4">ğŸ“‹ ã‚³ãƒŸãƒƒãƒˆå±¥æ­´: <span id="selected-law-name" class="text-blue-600"></span></h3>
        <div id="commit-list" class="space-y-3"></div>
        <div id="no-history" class="hidden text-center text-gray-500 py-8">
          <p>ã“ã®æ³•ä»¤ã®æ”¹æ­£å±¥æ­´ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
          <p class="text-sm mt-2">e-Gov API ã‹ã‚‰ã®ãƒ‡ãƒ¼ã‚¿æ›´æ–°æ™‚ã«å±¥æ­´ãŒè¿½åŠ ã•ã‚Œã¾ã™ã€‚</p>
        </div>
      </div>

      <!-- å·®åˆ†è¡¨ç¤º -->
      <div id="diff-section" class="hidden bg-white rounded-lg shadow-md p-6">
        <h3 class="text-lg font-bold mb-4">ğŸ“Š å¤‰æ›´å·®åˆ†</h3>
        <div id="diff-container"></div>
      </div>
    </div>

    <!-- æœ€è¿‘ã®å¤‰æ›´ -->
    <div class="bg-white rounded-lg shadow-md p-6">
      <h3 class="text-lg font-bold mb-4">ğŸ• æœ€è¿‘ã®æ³•ä»¤æ›´æ–°</h3>
      <div id="recent-changes" class="space-y-3">
        <p class="text-gray-500 text-center py-4">èª­ã¿è¾¼ã¿ä¸­...</p>
      </div>
    </div>
  </main>

  <script>
    let laws = [];
    let selectedLaw = null;

    // åˆæœŸåŒ–
    async function init() {
      try {
        const response = await fetch('./data/index/laws.json');
        const data = await response.json();
        laws = data.laws || [];

        // æ¤œç´¢ã‚µã‚¸ã‚§ã‚¹ãƒˆ
        const searchInput = document.getElementById('law-search');
        const suggestions = document.getElementById('law-suggestions');

        searchInput.addEventListener('input', (e) => {
          const query = e.target.value.toLowerCase();
          if (query.length < 2) {
            suggestions.classList.add('hidden');
            return;
          }

          const matches = laws.filter(l =>
            l.title.toLowerCase().includes(query)
          ).slice(0, 10);

          if (matches.length > 0) {
            suggestions.innerHTML = matches.map(l => `
              <div class="px-4 py-2 hover:bg-gray-100 cursor-pointer border-b" data-id="${l.id}" data-title="${l.title}" data-category="${l.category}">
                <span class="font-medium">${l.title}</span>
                <span class="text-xs text-gray-500 ml-2">${l.lawNum}</span>
              </div>
            `).join('');
            suggestions.classList.remove('hidden');

            // ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
            suggestions.querySelectorAll('div').forEach(el => {
              el.addEventListener('click', () => {
                selectedLaw = {
                  id: el.dataset.id,
                  title: el.dataset.title,
                  category: el.dataset.category
                };
                searchInput.value = el.dataset.title;
                suggestions.classList.add('hidden');
              });
            });
          } else {
            suggestions.classList.add('hidden');
          }
        });

        // å±¥æ­´è¡¨ç¤ºãƒœã‚¿ãƒ³
        document.getElementById('load-history-btn').addEventListener('click', loadHistory);

        // æœ€è¿‘ã®å¤‰æ›´ã‚’è¡¨ç¤º
        loadRecentChanges();

      } catch (error) {
        console.error('Failed to load laws:', error);
      }
    }

    // å±¥æ­´èª­ã¿è¾¼ã¿
    async function loadHistory() {
      if (!selectedLaw) {
        alert('æ³•ä»¤ã‚’é¸æŠã—ã¦ãã ã•ã„');
        return;
      }

      const historySection = document.getElementById('history-section');
      const commitList = document.getElementById('commit-list');
      const noHistory = document.getElementById('no-history');
      const diffSection = document.getElementById('diff-section');

      historySection.classList.remove('hidden');
      diffSection.classList.add('hidden');
      document.getElementById('selected-law-name').textContent = selectedLaw.title;

      // GitHub API ã‹ã‚‰ã‚³ãƒŸãƒƒãƒˆå±¥æ­´ã‚’å–å¾—
      try {
        const filePath = `data/markdown/${selectedLaw.category}/${selectedLaw.id}.md`;
        const response = await fetch(
          `https://api.github.com/repos/DaisukeHori/japan-law/commits?path=${filePath}&per_page=20`
        );

        if (!response.ok) throw new Error('API error');

        const commits = await response.json();

        if (commits.length === 0) {
          commitList.classList.add('hidden');
          noHistory.classList.remove('hidden');
          return;
        }

        commitList.classList.remove('hidden');
        noHistory.classList.add('hidden');

        commitList.innerHTML = commits.map((commit, index) => `
          <div class="commit-card border rounded-lg p-4 cursor-pointer hover:shadow-md transition-all"
               data-sha="${commit.sha}"
               data-path="${filePath}"
               data-index="${index}">
            <div class="flex items-start justify-between">
              <div>
                <p class="font-medium text-gray-800">${escapeHtml(commit.commit.message.split('\n')[0])}</p>
                <p class="text-sm text-gray-500 mt-1">
                  <span class="font-mono text-xs bg-gray-100 px-2 py-1 rounded">${commit.sha.slice(0, 7)}</span>
                  ${new Date(commit.commit.author.date).toLocaleDateString('ja-JP')}
                </p>
              </div>
              <button class="text-blue-600 hover:text-blue-800 text-sm" onclick="event.stopPropagation(); showDiff('${commit.sha}', '${filePath}')">
                å·®åˆ†ã‚’è¦‹ã‚‹
              </button>
            </div>
          </div>
        `).join('');

        // ã‚³ãƒŸãƒƒãƒˆã‚«ãƒ¼ãƒ‰ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
        commitList.querySelectorAll('.commit-card').forEach(card => {
          card.addEventListener('click', () => {
            showDiff(card.dataset.sha, card.dataset.path);
          });
        });

      } catch (error) {
        console.error('Failed to load history:', error);
        commitList.innerHTML = `
          <div class="text-center text-gray-500 py-8">
            <p>GitHub API ã‹ã‚‰ã®å±¥æ­´å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</p>
            <p class="text-sm mt-2">ãƒªãƒã‚¸ãƒˆãƒªã®å±¥æ­´ã¯ GitHub ã§ç›´æ¥ç¢ºèªã§ãã¾ã™ï¼š</p>
            <a href="https://github.com/DaisukeHori/japan-law/commits/main/data/markdown/${selectedLaw.category}/${selectedLaw.id}.md"
               target="_blank" class="text-blue-600 hover:underline">GitHub ã§å±¥æ­´ã‚’è¦‹ã‚‹</a>
          </div>
        `;
      }
    }

    // å·®åˆ†è¡¨ç¤º
    async function showDiff(sha, filePath) {
      const diffSection = document.getElementById('diff-section');
      const diffContainer = document.getElementById('diff-container');

      diffSection.classList.remove('hidden');
      diffContainer.innerHTML = '<p class="text-center py-4">å·®åˆ†ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>';

      try {
        // ã‚³ãƒŸãƒƒãƒˆã®å·®åˆ†ã‚’å–å¾—
        const response = await fetch(
          `https://api.github.com/repos/DaisukeHori/japan-law/commits/${sha}`,
          { headers: { Accept: 'application/vnd.github.v3.diff' } }
        );

        if (!response.ok) throw new Error('API error');

        const diffText = await response.text();

        // diff2htmlã§æç”»
        const diff2htmlUi = new Diff2HtmlUI(diffContainer, diffText, {
          drawFileList: false,
          matching: 'lines',
          outputFormat: 'side-by-side',
          renderNothingWhenEmpty: true,
        });
        diff2htmlUi.draw();
        diff2htmlUi.highlightCode();

        // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
        diffSection.scrollIntoView({ behavior: 'smooth', block: 'start' });

      } catch (error) {
        console.error('Failed to load diff:', error);
        diffContainer.innerHTML = `
          <div class="text-center text-gray-500 py-8">
            <p>å·®åˆ†ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</p>
            <a href="https://github.com/DaisukeHori/japan-law/commit/${sha}"
               target="_blank" class="text-blue-600 hover:underline">GitHub ã§å·®åˆ†ã‚’è¦‹ã‚‹</a>
          </div>
        `;
      }
    }

    // æœ€è¿‘ã®å¤‰æ›´
    async function loadRecentChanges() {
      const container = document.getElementById('recent-changes');

      try {
        const response = await fetch(
          'https://api.github.com/repos/DaisukeHori/japan-law/commits?path=data/markdown&per_page=10'
        );

        if (!response.ok) throw new Error('API error');

        const commits = await response.json();

        if (commits.length === 0) {
          container.innerHTML = '<p class="text-gray-500 text-center">æœ€è¿‘ã®æ›´æ–°ã¯ã‚ã‚Šã¾ã›ã‚“</p>';
          return;
        }

        container.innerHTML = commits.map(commit => `
          <div class="border rounded-lg p-3 hover:bg-gray-50">
            <p class="font-medium text-sm">${escapeHtml(commit.commit.message.split('\n')[0])}</p>
            <p class="text-xs text-gray-500 mt-1">
              <span class="font-mono bg-gray-100 px-1 rounded">${commit.sha.slice(0, 7)}</span>
              ${new Date(commit.commit.author.date).toLocaleDateString('ja-JP')}
            </p>
          </div>
        `).join('');

      } catch (error) {
        container.innerHTML = `
          <p class="text-gray-500 text-center">
            GitHub API ã‹ã‚‰ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚
            <a href="https://github.com/DaisukeHori/japan-law/commits/main/data/markdown"
               target="_blank" class="text-blue-600 hover:underline">GitHub ã§ç¢ºèª</a>
          </p>
        `;
      }
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    init();
  </script>
</body>
</html>
