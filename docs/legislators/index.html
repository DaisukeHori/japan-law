<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>è­°å“¡ä¸€è¦§ - æ—¥æœ¬æ³•ä»¤ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
</head>
<body class="bg-gray-50 min-h-screen">
  <div x-data="legislatorList()" x-init="loadData()">
    <!-- Header -->
    <header class="bg-blue-900 text-white py-6">
      <div class="max-w-6xl mx-auto px-4">
        <nav class="text-blue-200 text-sm mb-2">
          <a href="../" class="hover:underline">ãƒ›ãƒ¼ãƒ </a> &gt; è­°å“¡ä¸€è¦§
        </nav>
        <h1 class="text-3xl font-bold">ğŸ›ï¸ è­°å“¡æ´»å‹•ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>
      </div>
    </header>

    <main class="max-w-6xl mx-auto px-4 py-8">
      <!-- ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
      <section class="bg-white rounded-lg shadow-md p-4 mb-6">
        <div class="flex flex-wrap gap-4 items-center">
          <div>
            <label class="text-sm text-gray-600">æ”¿å…š</label>
            <select x-model="filterParty" class="ml-2 rounded border-gray-300 text-sm">
              <option value="">å…¨ã¦</option>
              <template x-for="party in uniqueParties" :key="party">
                <option :value="party" x-text="party"></option>
              </template>
            </select>
          </div>

          <div>
            <label class="text-sm text-gray-600">ä¸¦ã³é †</label>
            <select x-model="sortBy" class="ml-2 rounded border-gray-300 text-sm">
              <option value="speech_count">ç™ºè¨€æ•°</option>
              <option value="support">è³›æˆæ•°</option>
              <option value="oppose">åå¯¾æ•°</option>
              <option value="name">åå‰</option>
            </select>
          </div>

          <div class="flex-1">
            <input
              type="text"
              x-model="searchQuery"
              placeholder="è­°å“¡åã§æ¤œç´¢..."
              class="w-full max-w-xs rounded border-gray-300 text-sm px-3 py-2"
            >
          </div>
        </div>
      </section>

      <!-- çµ±è¨ˆã‚µãƒãƒªãƒ¼ -->
      <section class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
        <div class="bg-white rounded-lg shadow p-4 text-center">
          <div class="text-2xl font-bold text-blue-600" x-text="stats.total_legislators || 0"></div>
          <div class="text-sm text-gray-500">è¿½è·¡è­°å“¡æ•°</div>
        </div>
        <div class="bg-white rounded-lg shadow p-4 text-center">
          <div class="text-2xl font-bold text-green-600" x-text="stats.total_speeches || 0"></div>
          <div class="text-sm text-gray-500">ç·ç™ºè¨€è¨˜éŒ²</div>
        </div>
        <div class="bg-white rounded-lg shadow p-4 text-center">
          <div class="text-2xl font-bold text-emerald-600" x-text="stats.total_support || 0"></div>
          <div class="text-sm text-gray-500">ğŸŸ¢ è³›æˆç™ºè¨€</div>
        </div>
        <div class="bg-white rounded-lg shadow p-4 text-center">
          <div class="text-2xl font-bold text-red-600" x-text="stats.total_oppose || 0"></div>
          <div class="text-sm text-gray-500">ğŸ”´ åå¯¾ç™ºè¨€</div>
        </div>
      </section>

      <!-- å…šæ´¾åˆ¥çµ±è¨ˆ -->
      <section class="bg-white rounded-lg shadow-md p-4 mb-6" x-show="partyStats.length > 0">
        <h2 class="text-lg font-semibold mb-4">ğŸ¢ å…šæ´¾åˆ¥çµ±è¨ˆ</h2>
        <div class="overflow-x-auto">
          <table class="w-full text-sm">
            <thead class="bg-gray-50 border-b">
              <tr>
                <th class="px-4 py-2 text-left">å…šæ´¾</th>
                <th class="px-4 py-2 text-right">è­°å“¡æ•°</th>
                <th class="px-4 py-2 text-right">ç™ºè¨€æ•°</th>
                <th class="px-4 py-2 text-right">ğŸŸ¢ è³›æˆ</th>
                <th class="px-4 py-2 text-right">ğŸ”´ åå¯¾</th>
              </tr>
            </thead>
            <tbody class="divide-y">
              <template x-for="p in partyStats" :key="p.party">
                <tr class="hover:bg-gray-50">
                  <td class="px-4 py-2">
                    <span class="inline-block px-2 py-1 text-xs rounded-full"
                          :style="{ backgroundColor: getPartyColor(p.party) + '20', color: getPartyColor(p.party) }"
                          x-text="p.party"></span>
                  </td>
                  <td class="px-4 py-2 text-right" x-text="p.count + 'å'"></td>
                  <td class="px-4 py-2 text-right font-medium" x-text="p.speeches + 'ä»¶'"></td>
                  <td class="px-4 py-2 text-right text-green-600" x-text="p.support"></td>
                  <td class="px-4 py-2 text-right text-red-600" x-text="p.oppose"></td>
                </tr>
              </template>
            </tbody>
          </table>
        </div>
      </section>

      <!-- è­°å“¡ãƒ†ãƒ¼ãƒ–ãƒ« -->
      <section class="bg-white rounded-lg shadow-md overflow-hidden">
        <h2 class="text-lg font-semibold p-4 border-b">ğŸ¤ ç™ºè¨€æ•°ãƒ©ãƒ³ã‚­ãƒ³ã‚°</h2>
        <div class="overflow-x-auto">
          <table class="w-full">
            <thead class="bg-gray-50 border-b">
              <tr>
                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">è­°å“¡å</th>
                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">æ‰€å±</th>
                <th class="px-4 py-3 text-right text-sm font-semibold text-gray-600">ç™ºè¨€æ•°</th>
                <th class="px-4 py-3 text-center text-sm font-semibold text-gray-600">ã‚¹ã‚¿ãƒ³ã‚¹</th>
                <th class="px-4 py-3 text-center text-sm font-semibold text-gray-600">è©³ç´°</th>
              </tr>
            </thead>
            <tbody class="divide-y">
              <template x-for="(leg, index) in filteredLegislators" :key="leg.name">
                <tr class="hover:bg-gray-50">
                  <td class="px-4 py-3">
                    <span class="font-medium" x-text="leg.name"></span>
                  </td>
                  <td class="px-4 py-3">
                    <span
                      class="inline-block px-2 py-1 text-xs rounded-full"
                      :style="{ backgroundColor: getPartyColor(leg.party) + '20', color: getPartyColor(leg.party) }"
                      x-text="leg.party || '-'"
                    ></span>
                  </td>
                  <td class="px-4 py-3 text-right font-medium" x-text="leg.speech_count || 0"></td>
                  <td class="px-4 py-3 text-center">
                    <span class="text-xs" x-show="leg.stance_summary">
                      <span class="text-green-600" x-text="'ğŸŸ¢' + (leg.stance_summary?.support || 0)"></span>
                      <span class="mx-1">/</span>
                      <span class="text-red-600" x-text="'ğŸ”´' + (leg.stance_summary?.oppose || 0)"></span>
                    </span>
                  </td>
                  <td class="px-4 py-3 text-center">
                    <a :href="'./' + encodeURIComponent(leg.name) + '.md'"
                       class="text-blue-600 hover:underline text-sm">
                      ğŸ“„ ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«
                    </a>
                  </td>
                </tr>
              </template>
              <tr x-show="filteredLegislators.length === 0 && !loading">
                <td colspan="5" class="px-4 py-8 text-center text-gray-500">
                  è©²å½“ã™ã‚‹è­°å“¡ãŒã„ã¾ã›ã‚“
                </td>
              </tr>
              <tr x-show="loading">
                <td colspan="5" class="px-4 py-8 text-center text-gray-500">
                  ğŸ“Š ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ä¸­...
                </td>
              </tr>
            </tbody>
          </table>
        </div>
        <div class="p-4 border-t text-sm text-gray-500" x-show="filteredLegislators.length > 0">
          <span x-text="filteredLegislators.length"></span> åã®è­°å“¡ã‚’è¡¨ç¤ºä¸­
        </div>
      </section>

      <!-- GitHub Issues ãƒªãƒ³ã‚¯ -->
      <section class="mt-6 p-4 bg-blue-50 rounded-lg">
        <h3 class="font-semibold text-blue-900 mb-2">ğŸ” GitHub Issuesã§æ¤œç´¢</h3>
        <div class="flex flex-wrap gap-2">
          <a href="https://github.com/DaisukeHori/japan-law/issues?q=is%3Aissue+label%3Aæ³•æ¡ˆ"
             class="text-blue-600 hover:underline text-sm" target="_blank">
            å…¨ã¦ã®æ³•æ¡ˆIssue
          </a>
          <span class="text-gray-400">|</span>
          <a href="https://github.com/DaisukeHori/japan-law/issues?q=is%3Aissue+label%3Aæˆç«‹"
             class="text-blue-600 hover:underline text-sm" target="_blank">
            æˆç«‹ã—ãŸæ³•æ¡ˆ
          </a>
          <span class="text-gray-400">|</span>
          <a href="https://github.com/DaisukeHori/japan-law/labels?q=ç™ºè¨€è€…"
             class="text-blue-600 hover:underline text-sm" target="_blank">
            ç™ºè¨€è€…ãƒ©ãƒ™ãƒ«ä¸€è¦§
          </a>
        </div>
      </section>
    </main>

    <footer class="bg-gray-800 text-gray-400 py-6 mt-8">
      <div class="max-w-6xl mx-auto px-4 text-center">
        <p>Â© 2026 Japan Law Database Project</p>
        <p class="text-sm mt-2">ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹: å›½ä¼šä¼šè­°éŒ²æ¤œç´¢ã‚·ã‚¹ãƒ†ãƒ APIã€SMRIæ³•æ¡ˆãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹</p>
      </div>
    </footer>
  </div>

  <script>
    function legislatorList() {
      return {
        legislators: [],
        stats: {},
        partyStats: [],
        filterParty: '',
        sortBy: 'speech_count',
        searchQuery: '',
        loading: true,

        async loadData() {
          try {
            // ç™ºè¨€ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’èª­ã¿è¾¼ã¿ï¼ˆMarkdownãƒšãƒ¼ã‚¸ã¨åŒã˜ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ï¼‰
            const speechRes = await fetch('../../data/index/legislators/legislator_speeches.json');
            const speechData = await speechRes.json();

            // çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ã‚’è¨­å®š
            this.stats = {
              total_legislators: speechData.total_legislators || 0,
              total_speeches: speechData.total_speeches || 0,
              total_support: 0,
              total_oppose: 0
            };

            // è­°å“¡ãƒ‡ãƒ¼ã‚¿ã‚’é…åˆ—ã«å¤‰æ›
            const legArray = [];
            const partyMap = {};

            for (const [name, record] of Object.entries(speechData.legislators || {})) {
              const leg = {
                name,
                party: record.party || '',
                speech_count: record.speech_count || 0,
                stance_summary: record.stance_summary || { support: 0, oppose: 0, neutral: 0 },
                bills: record.bills || []
              };
              legArray.push(leg);

              // çµ±è¨ˆã‚’é›†è¨ˆ
              this.stats.total_support += leg.stance_summary.support;
              this.stats.total_oppose += leg.stance_summary.oppose;

              // å…šæ´¾åˆ¥çµ±è¨ˆ
              const party = leg.party || 'ä¸æ˜';
              if (!partyMap[party]) {
                partyMap[party] = { party, count: 0, speeches: 0, support: 0, oppose: 0 };
              }
              partyMap[party].count++;
              partyMap[party].speeches += leg.speech_count;
              partyMap[party].support += leg.stance_summary.support;
              partyMap[party].oppose += leg.stance_summary.oppose;
            }

            this.legislators = legArray;
            this.partyStats = Object.values(partyMap)
              .sort((a, b) => b.speeches - a.speeches)
              .slice(0, 10);

          } catch (e) {
            console.error('Failed to load data:', e);
            // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: å¾“æ¥ã®ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ã‚’è©¦ã™
            try {
              const [statsRes, partiesRes, legislatorsRes] = await Promise.all([
                fetch('../../data/index/legislators/activity_stats.json'),
                fetch('../../data/index/legislators/parties.json'),
                fetch('../../data/index/legislators/legislators.json')
              ]);

              const statsData = await statsRes.json();
              const legislatorsData = await legislatorsRes.json();

              this.stats = statsData.summary || {};
              const statsByLeg = statsData.by_legislator || {};
              this.legislators = (legislatorsData.legislators || []).map(leg => ({
                name: leg.name,
                party: leg.party,
                speech_count: statsByLeg[leg.id]?.total_bills || 0,
                stance_summary: { support: 0, oppose: 0, neutral: 0 }
              }));
            } catch (e2) {
              console.error('Fallback also failed:', e2);
            }
          }
          this.loading = false;
        },

        get uniqueParties() {
          return [...new Set(this.legislators.map(l => l.party).filter(Boolean))].sort();
        },

        get filteredLegislators() {
          let result = this.legislators;

          if (this.filterParty) {
            result = result.filter(l => l.party === this.filterParty);
          }
          if (this.searchQuery) {
            const q = this.searchQuery.toLowerCase();
            result = result.filter(l => l.name.toLowerCase().includes(q));
          }

          // ã‚½ãƒ¼ãƒˆ
          result = [...result].sort((a, b) => {
            if (this.sortBy === 'name') {
              return (a.name || '').localeCompare(b.name || '');
            }
            if (this.sortBy === 'support') {
              return (b.stance_summary?.support || 0) - (a.stance_summary?.support || 0);
            }
            if (this.sortBy === 'oppose') {
              return (b.stance_summary?.oppose || 0) - (a.stance_summary?.oppose || 0);
            }
            return (b.speech_count || 0) - (a.speech_count || 0);
          });

          return result;
        },

        getPartyColor(partyName) {
          const colors = {
            'è‡ªç”±æ°‘ä¸»å…š': '#e74c3c',
            'è‡ªæ°‘': '#e74c3c',
            'ç«‹æ†²æ°‘ä¸»å…š': '#3498db',
            'ç«‹æ†²': '#3498db',
            'å…¬æ˜å…š': '#f39c12',
            'å…¬æ˜': '#f39c12',
            'æ—¥æœ¬ç¶­æ–°ã®ä¼š': '#27ae60',
            'ç¶­æ–°': '#27ae60',
            'å›½æ°‘æ°‘ä¸»å…š': '#9b59b6',
            'å›½æ°‘': '#9b59b6',
            'æ—¥æœ¬å…±ç”£å…š': '#c0392b',
            'å…±ç”£': '#c0392b',
            'ã‚Œã„ã‚æ–°é¸çµ„': '#e91e63',
            'ã‚Œã„ã‚': '#e91e63',
            'ç¤¾ä¼šæ°‘ä¸»å…š': '#ff6b6b',
            'ç¤¾æ°‘': '#ff6b6b',
          };
          for (const [name, color] of Object.entries(colors)) {
            if (partyName?.includes(name)) return color;
          }
          return '#666666';
        }
      };
    }
  </script>
</body>
</html>
