<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ³•ä»¤å‚ç…§ã‚°ãƒ©ãƒ• - æ—¥æœ¬æ³•ä»¤ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    #graph-container {
      width: 100%;
      height: 600px;
      background: #f8fafc;
      border-radius: 8px;
      overflow: hidden;
    }
    .node circle {
      stroke: #fff;
      stroke-width: 2px;
      cursor: pointer;
    }
    .node text {
      font-size: 10px;
      pointer-events: none;
    }
    .link {
      stroke: #999;
      stroke-opacity: 0.6;
    }
    .link.highlighted {
      stroke: #3b82f6;
      stroke-width: 3px;
      stroke-opacity: 1;
    }
    .node.highlighted circle {
      stroke: #3b82f6;
      stroke-width: 4px;
    }
  </style>
</head>
<body class="bg-gray-50 min-h-screen">
  <header class="bg-blue-900 text-white py-6">
    <div class="max-w-7xl mx-auto px-4">
      <nav class="text-blue-200 text-sm mb-2">
        <a href="../" class="hover:underline">ãƒ›ãƒ¼ãƒ </a> &gt; æ³•ä»¤å‚ç…§ã‚°ãƒ©ãƒ•
      </nav>
      <h1 class="text-3xl font-bold">ğŸ”— æ³•ä»¤å‚ç…§ã‚°ãƒ©ãƒ•</h1>
      <p class="text-blue-200 mt-1">æ³•ä»¤é–“ã®å‚ç…§é–¢ä¿‚ã‚’å¯è¦–åŒ–ãƒ»æ¢ç´¢</p>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-4 py-8">
    <!-- ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ‘ãƒãƒ« -->
    <section class="bg-white rounded-lg shadow-md p-4 mb-6">
      <div class="grid md:grid-cols-3 gap-4">
        <!-- èµ·ç‚¹æ³•ä»¤é¸æŠ -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">èµ·ç‚¹æ³•ä»¤</label>
          <select id="startLaw" class="w-full rounded border-gray-300">
            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
          </select>
        </div>
        
        <!-- çµ‚ç‚¹æ³•ä»¤é¸æŠ -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">çµ‚ç‚¹æ³•ä»¤ï¼ˆçµŒè·¯æ¤œç´¢æ™‚ï¼‰</label>
          <select id="endLaw" class="w-full rounded border-gray-300">
            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
          </select>
        </div>
        
        <!-- æ“ä½œãƒœã‚¿ãƒ³ -->
        <div class="flex items-end gap-2">
          <button id="showReferences" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
            å‚ç…§ã‚’è¡¨ç¤º
          </button>
          <button id="findPath" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">
            çµŒè·¯ã‚’æ¤œç´¢
          </button>
          <button id="resetGraph" class="px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-700">
            ãƒªã‚»ãƒƒãƒˆ
          </button>
        </div>
      </div>
      
      <!-- ãƒ›ãƒƒãƒ—æ•°ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ -->
      <div class="mt-4">
        <label class="block text-sm font-medium text-gray-700 mb-1">
          è¡¨ç¤ºãƒ›ãƒƒãƒ—æ•°: <span id="hopValue">2</span>
        </label>
        <input type="range" id="hopSlider" min="1" max="10" value="2" class="w-full max-w-xs">
      </div>
    </section>

    <!-- çµ±è¨ˆãƒ‘ãƒãƒ« -->
    <section class="grid md:grid-cols-4 gap-4 mb-6">
      <div class="bg-white rounded-lg shadow p-4">
        <div class="text-2xl font-bold text-blue-600" id="stat-nodes">-</div>
        <div class="text-sm text-gray-500">ã‚¢ã‚¯ãƒ†ã‚£ãƒ–æ³•ä»¤</div>
      </div>
      <div class="bg-white rounded-lg shadow p-4">
        <div class="text-2xl font-bold text-green-600" id="stat-edges">-</div>
        <div class="text-sm text-gray-500">å‚ç…§é–¢ä¿‚</div>
      </div>
      <div class="bg-white rounded-lg shadow p-4">
        <div class="text-2xl font-bold text-yellow-600" id="stat-selected">-</div>
        <div class="text-sm text-gray-500">é¸æŠä¸­ã®ãƒãƒ¼ãƒ‰</div>
      </div>
      <div class="bg-white rounded-lg shadow p-4">
        <div class="text-2xl font-bold text-purple-600" id="stat-path">-</div>
        <div class="text-sm text-gray-500">çµŒè·¯ãƒ›ãƒƒãƒ—æ•°</div>
      </div>
    </section>

    <!-- ã‚°ãƒ©ãƒ•è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
    <section class="bg-white rounded-lg shadow-md mb-6">
      <div id="graph-container"></div>
    </section>

    <!-- è©³ç´°ãƒ‘ãƒãƒ« -->
    <section class="grid md:grid-cols-2 gap-6">
      <!-- é¸æŠã—ãŸæ³•ä»¤ã®æƒ…å ± -->
      <div class="bg-white rounded-lg shadow-md p-4">
        <h3 class="text-lg font-bold mb-3">ğŸ“‹ é¸æŠã—ãŸæ³•ä»¤</h3>
        <div id="selectedLawInfo" class="text-gray-600">
          æ³•ä»¤ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨è©³ç´°ãŒè¡¨ç¤ºã•ã‚Œã¾ã™
        </div>
      </div>
      
      <!-- çµŒè·¯æƒ…å ± -->
      <div class="bg-white rounded-lg shadow-md p-4">
        <h3 class="text-lg font-bold mb-3">ğŸ›¤ï¸ çµŒè·¯</h3>
        <div id="pathInfo" class="text-gray-600">
          2ã¤ã®æ³•ä»¤ã‚’é¸æŠã—ã¦ã€ŒçµŒè·¯ã‚’æ¤œç´¢ã€ã‚’ã‚¯ãƒªãƒƒã‚¯
        </div>
      </div>
    </section>

    <!-- è¢«å‚ç…§ãƒ©ãƒ³ã‚­ãƒ³ã‚° -->
    <section class="bg-white rounded-lg shadow-md p-4 mt-6">
      <h3 class="text-lg font-bold mb-3">ğŸ† è¢«å‚ç…§æ•°ãƒ©ãƒ³ã‚­ãƒ³ã‚°</h3>
      <div id="ranking" class="grid md:grid-cols-2 gap-4">
        èª­ã¿è¾¼ã¿ä¸­...
      </div>
    </section>
  </main>

  <footer class="bg-gray-800 text-gray-400 py-6 mt-8">
    <div class="max-w-7xl mx-auto px-4 text-center">
      <p>Â© 2025 Japan Law Database Project</p>
    </div>
  </footer>

  <script>
    // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
    let nodes = [];
    let edges = [];
    let reachability = {};
    let nodeMap = new Map();
    let simulation = null;
    let svg = null;
    let g = null;

    // ã‚«ãƒ†ã‚´ãƒªã‚«ãƒ©ãƒ¼
    const categoryColors = {
      constitution: '#8b5cf6',
      acts: '#3b82f6',
      cabinet_orders: '#10b981',
      imperial_orders: '#f59e0b',
      ministerial_ordinances: '#ef4444',
      rules: '#ec4899',
      misc: '#6b7280',
    };

    // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
    async function loadData() {
      try {
        const [nodesRes, edgesRes, reachRes] = await Promise.all([
          fetch('../data/index/graph/nodes.json'),
          fetch('../data/index/graph/edges.json'),
          fetch('../data/index/graph/reachability.json').catch(() => ({ json: () => ({ data: {} }) })),
        ]);

        const nodesData = await nodesRes.json();
        const edgesData = await edgesRes.json();
        const reachData = await reachRes.json();

        nodes = nodesData.nodes || [];
        edges = edgesData.edges || [];
        reachability = reachData.data || {};

        // ãƒãƒ¼ãƒ‰ãƒãƒƒãƒ—ä½œæˆ
        for (const node of nodes) {
          nodeMap.set(node.id, node);
        }

        // çµ±è¨ˆæ›´æ–°
        document.getElementById('stat-nodes').textContent = nodes.length.toLocaleString();
        document.getElementById('stat-edges').textContent = edges.length.toLocaleString();

        // ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹è¨­å®š
        populateSelects();

        // ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¡¨ç¤º
        showRanking();

        // åˆæœŸã‚°ãƒ©ãƒ•ï¼ˆãƒˆãƒƒãƒ—50ï¼‰
        showTopLaws(50);

      } catch (e) {
        console.error('Failed to load data:', e);
        document.getElementById('graph-container').innerHTML = 
          '<p class="p-8 text-center text-gray-500">ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚å…ˆã«build_full_graph.tsã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚</p>';
      }
    }

    // ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã‚’è¨­å®š
    function populateSelects() {
      const sortedNodes = [...nodes].sort((a, b) => b.in_degree - a.in_degree);
      const startSelect = document.getElementById('startLaw');
      const endSelect = document.getElementById('endLaw');

      for (const node of sortedNodes.slice(0, 500)) {
        const option1 = document.createElement('option');
        option1.value = node.id;
        option1.textContent = `${node.title} (è¢«å‚ç…§: ${node.in_degree})`;
        startSelect.appendChild(option1);

        const option2 = option1.cloneNode(true);
        endSelect.appendChild(option2);
      }
    }

    // ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¡¨ç¤º
    function showRanking() {
      const sorted = [...nodes].sort((a, b) => b.in_degree - a.in_degree).slice(0, 20);
      const container = document.getElementById('ranking');
      
      container.innerHTML = sorted.map((node, i) => `
        <div class="flex items-center justify-between py-2 border-b cursor-pointer hover:bg-gray-50" 
             onclick="selectLaw('${node.id}')">
          <div class="flex items-center">
            <span class="w-6 h-6 flex items-center justify-center bg-blue-100 text-blue-800 rounded-full text-sm font-bold mr-2">${i + 1}</span>
            <span class="text-sm">${node.title}</span>
          </div>
          <span class="text-gray-500 text-sm">${node.in_degree} æ³•ä»¤ã‹ã‚‰å‚ç…§</span>
        </div>
      `).join('');
    }

    // ãƒˆãƒƒãƒ—æ³•ä»¤ã‚’è¡¨ç¤º
    function showTopLaws(count) {
      const topNodes = [...nodes]
        .sort((a, b) => b.in_degree - a.in_degree)
        .slice(0, count);

      const topIds = new Set(topNodes.map(n => n.id));
      const filteredEdges = edges.filter(e => topIds.has(e.from) && topIds.has(e.to));

      renderGraph(topNodes, filteredEdges);
    }

    // å‚ç…§ã‚’è¡¨ç¤º
    function showReferences() {
      const startId = document.getElementById('startLaw').value;
      if (!startId) {
        alert('èµ·ç‚¹æ³•ä»¤ã‚’é¸æŠã—ã¦ãã ã•ã„');
        return;
      }

      const maxHops = parseInt(document.getElementById('hopSlider').value);
      const { visitedNodes, visitedEdges } = traverseGraph(startId, maxHops);

      const filteredNodes = nodes.filter(n => visitedNodes.has(n.id));
      const filteredEdges = edges.filter(e => visitedEdges.has(`${e.from}-${e.to}`));

      document.getElementById('stat-selected').textContent = filteredNodes.length;
      renderGraph(filteredNodes, filteredEdges, startId);
    }

    // ã‚°ãƒ©ãƒ•æ¢ç´¢ï¼ˆBFSï¼‰
    function traverseGraph(startId, maxHops) {
      const visitedNodes = new Set([startId]);
      const visitedEdges = new Set();
      const queue = [{ id: startId, hop: 0 }];

      while (queue.length > 0) {
        const { id, hop } = queue.shift();
        if (hop >= maxHops) continue;

        // å‡ºåŠ›ã‚¨ãƒƒã‚¸ï¼ˆã“ã®æ³•ä»¤ãŒå‚ç…§ã—ã¦ã„ã‚‹ï¼‰
        for (const edge of edges) {
          if (edge.from === id && !visitedNodes.has(edge.to)) {
            visitedNodes.add(edge.to);
            visitedEdges.add(`${edge.from}-${edge.to}`);
            queue.push({ id: edge.to, hop: hop + 1 });
          }
        }

        // å…¥åŠ›ã‚¨ãƒƒã‚¸ï¼ˆã“ã®æ³•ä»¤ã‚’å‚ç…§ã—ã¦ã„ã‚‹ï¼‰
        for (const edge of edges) {
          if (edge.to === id && !visitedNodes.has(edge.from)) {
            visitedNodes.add(edge.from);
            visitedEdges.add(`${edge.from}-${edge.to}`);
            queue.push({ id: edge.from, hop: hop + 1 });
          }
        }
      }

      return { visitedNodes, visitedEdges };
    }

    // çµŒè·¯æ¤œç´¢ï¼ˆBFSï¼‰
    function findPath() {
      const startId = document.getElementById('startLaw').value;
      const endId = document.getElementById('endLaw').value;

      if (!startId || !endId) {
        alert('èµ·ç‚¹ã¨çµ‚ç‚¹ã®ä¸¡æ–¹ã‚’é¸æŠã—ã¦ãã ã•ã„');
        return;
      }

      // éš£æ¥ãƒªã‚¹ãƒˆä½œæˆ
      const adj = new Map();
      for (const edge of edges) {
        if (!adj.has(edge.from)) adj.set(edge.from, []);
        adj.get(edge.from).push(edge.to);
      }

      // BFS
      const queue = [{ id: startId, path: [startId] }];
      const visited = new Set([startId]);

      while (queue.length > 0) {
        const { id, path } = queue.shift();

        if (id === endId) {
          // çµŒè·¯ç™ºè¦‹
          showPath(path);
          return;
        }

        const neighbors = adj.get(id) || [];
        for (const neighbor of neighbors) {
          if (!visited.has(neighbor)) {
            visited.add(neighbor);
            queue.push({ id: neighbor, path: [...path, neighbor] });
          }
        }
      }

      document.getElementById('pathInfo').innerHTML = 
        '<span class="text-red-500">çµŒè·¯ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ</span>';
      document.getElementById('stat-path').textContent = 'Ã—';
    }

    // çµŒè·¯ã‚’è¡¨ç¤º
    function showPath(pathIds) {
      document.getElementById('stat-path').textContent = (pathIds.length - 1) + 'ãƒ›ãƒƒãƒ—';

      const pathHtml = pathIds.map((id, i) => {
        const node = nodeMap.get(id);
        const arrow = i < pathIds.length - 1 ? ' â†’ ' : '';
        return `<span class="font-medium">${node?.title || id}</span>${arrow}`;
      }).join('');

      document.getElementById('pathInfo').innerHTML = pathHtml;

      // ã‚°ãƒ©ãƒ•ä¸Šã§ãƒã‚¤ãƒ©ã‚¤ãƒˆ
      const pathSet = new Set(pathIds);
      const pathEdges = new Set();
      for (let i = 0; i < pathIds.length - 1; i++) {
        pathEdges.add(`${pathIds[i]}-${pathIds[i + 1]}`);
      }

      // çµŒè·¯ã«é–¢ä¿‚ã™ã‚‹ãƒãƒ¼ãƒ‰ã¨ã‚¨ãƒƒã‚¸ã®ã¿è¡¨ç¤º
      const filteredNodes = nodes.filter(n => pathSet.has(n.id));
      const filteredEdges = edges.filter(e => pathEdges.has(`${e.from}-${e.to}`));

      renderGraph(filteredNodes, filteredEdges, pathIds[0], pathIds);
    }

    // ã‚°ãƒ©ãƒ•æç”»
    function renderGraph(graphNodes, graphEdges, highlightId = null, pathIds = []) {
      const container = document.getElementById('graph-container');
      container.innerHTML = '';

      const width = container.clientWidth;
      const height = container.clientHeight;

      svg = d3.select('#graph-container')
        .append('svg')
        .attr('width', width)
        .attr('height', height);

      // ã‚ºãƒ¼ãƒ æ©Ÿèƒ½
      const zoom = d3.zoom()
        .scaleExtent([0.1, 4])
        .on('zoom', (event) => {
          g.attr('transform', event.transform);
        });

      svg.call(zoom);

      g = svg.append('g');

      // ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
      simulation = d3.forceSimulation(graphNodes)
        .force('link', d3.forceLink(graphEdges).id(d => d.id).distance(100))
        .force('charge', d3.forceManyBody().strength(-300))
        .force('center', d3.forceCenter(width / 2, height / 2))
        .force('collision', d3.forceCollide().radius(30));

      // ã‚¨ãƒƒã‚¸
      const pathSet = new Set(pathIds);
      const link = g.append('g')
        .selectAll('line')
        .data(graphEdges)
        .join('line')
        .attr('class', d => {
          const isPath = pathIds.length > 1 && 
            pathIds.includes(d.from) && pathIds.includes(d.to);
          return isPath ? 'link highlighted' : 'link';
        })
        .attr('stroke-width', d => Math.min(d.count, 5));

      // ãƒãƒ¼ãƒ‰
      const node = g.append('g')
        .selectAll('g')
        .data(graphNodes)
        .join('g')
        .attr('class', d => pathSet.has(d.id) ? 'node highlighted' : 'node')
        .call(d3.drag()
          .on('start', dragstarted)
          .on('drag', dragged)
          .on('end', dragended));

      node.append('circle')
        .attr('r', d => 5 + Math.sqrt(d.in_degree) * 2)
        .attr('fill', d => categoryColors[d.category] || '#6b7280')
        .on('click', (event, d) => selectLaw(d.id));

      node.append('text')
        .attr('dx', 12)
        .attr('dy', 4)
        .text(d => d.title.length > 15 ? d.title.substring(0, 15) + '...' : d.title);

      simulation.on('tick', () => {
        link
          .attr('x1', d => d.source.x)
          .attr('y1', d => d.source.y)
          .attr('x2', d => d.target.x)
          .attr('y2', d => d.target.y);

        node.attr('transform', d => `translate(${d.x},${d.y})`);
      });

      function dragstarted(event) {
        if (!event.active) simulation.alphaTarget(0.3).restart();
        event.subject.fx = event.subject.x;
        event.subject.fy = event.subject.y;
      }

      function dragged(event) {
        event.subject.fx = event.x;
        event.subject.fy = event.y;
      }

      function dragended(event) {
        if (!event.active) simulation.alphaTarget(0);
        event.subject.fx = null;
        event.subject.fy = null;
      }
    }

    // æ³•ä»¤é¸æŠ
    function selectLaw(lawId) {
      const node = nodeMap.get(lawId);
      if (!node) return;

      document.getElementById('startLaw').value = lawId;
      
      const info = `
        <div class="space-y-2">
          <h4 class="font-bold text-lg">${node.title}</h4>
          <p class="text-sm text-gray-600">ã‚«ãƒ†ã‚´ãƒª: ${node.category}</p>
          <p class="text-sm">ã“ã®æ³•ä»¤ãŒå‚ç…§: <strong>${node.out_degree}</strong> æ³•ä»¤</p>
          <p class="text-sm">ã“ã®æ³•ä»¤ã‚’å‚ç…§: <strong>${node.in_degree}</strong> æ³•ä»¤</p>
        </div>
      `;
      document.getElementById('selectedLawInfo').innerHTML = info;
      document.getElementById('stat-selected').textContent = 1;
    }

    // ãƒªã‚»ãƒƒãƒˆ
    function resetGraph() {
      document.getElementById('startLaw').value = '';
      document.getElementById('endLaw').value = '';
      document.getElementById('stat-selected').textContent = '-';
      document.getElementById('stat-path').textContent = '-';
      document.getElementById('selectedLawInfo').innerHTML = 'æ³•ä»¤ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨è©³ç´°ãŒè¡¨ç¤ºã•ã‚Œã¾ã™';
      document.getElementById('pathInfo').innerHTML = '2ã¤ã®æ³•ä»¤ã‚’é¸æŠã—ã¦ã€ŒçµŒè·¯ã‚’æ¤œç´¢ã€ã‚’ã‚¯ãƒªãƒƒã‚¯';
      showTopLaws(50);
    }

    // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
    document.getElementById('showReferences').addEventListener('click', showReferences);
    document.getElementById('findPath').addEventListener('click', findPath);
    document.getElementById('resetGraph').addEventListener('click', resetGraph);
    document.getElementById('hopSlider').addEventListener('input', (e) => {
      document.getElementById('hopValue').textContent = e.target.value;
    });

    // åˆæœŸåŒ–
    loadData();
  </script>
</body>
</html>
