name: Update Law Database

on:
  schedule:
    # æ¯Žé€±æ—¥æ›œæ—¥ã®åˆå‰3æ™‚ï¼ˆJSTï¼‰ã«å®Ÿè¡Œ
    - cron: '0 18 * * 0'
  workflow_dispatch:
    inputs:
      full_update:
        description: 'Perform full update (not incremental)'
        required: false
        default: 'false'
        type: boolean

permissions:
  contents: write
  issues: write

jobs:
  update:
    runs-on: ubuntu-latest
    timeout-minutes: 120

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci
        working-directory: scripts

      - name: Run incremental update
        run: |
          echo "Starting law database update..."
          node --loader ts-node/esm incremental_update.ts
        working-directory: scripts
        env:
          NODE_OPTIONS: '--max-old-space-size=4096 --no-warnings'

      - name: Run reference analysis
        run: |
          echo "Analyzing law references..."
          node --loader ts-node/esm analyze_references_multi.ts
        working-directory: scripts
        env:
          NODE_OPTIONS: '--max-old-space-size=4096 --no-warnings'

      - name: Update legislators and parties
        run: |
          echo "Updating legislators, parties, and bills data..."
          node --loader ts-node/esm auto_update.ts
        working-directory: scripts
        env:
          NODE_OPTIONS: '--max-old-space-size=4096 --no-warnings'

      - name: Generate documentation site
        run: |
          echo "Generating documentation..."
          node --loader ts-node/esm generate_docs.ts
        working-directory: scripts
        env:
          NODE_OPTIONS: '--max-old-space-size=4096 --no-warnings'

      - name: Check for changes
        id: check_changes
        run: |
          git add -A
          if git diff --staged --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No changes detected"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "Changes detected:"
            git diff --staged --stat | head -20
          fi

      - name: Commit and push changes
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Get date for commit message
          DATE=$(date +%Y-%m-%d)

          # Count changes
          NEW_LAWS=$(git diff --staged --name-only | grep "^data/xml/" | grep -v "^data/xml/.*/" | wc -l || echo "0")
          UPDATED_LAWS=$(git diff --staged --name-only --diff-filter=M | grep "^data/xml/" | wc -l || echo "0")

          git commit -m "ðŸ“š æ³•ä»¤ãƒ‡ãƒ¼ã‚¿æ›´æ–°: ${DATE}

          - æ–°è¦æ³•ä»¤: ${NEW_LAWS} ä»¶
          - æ›´æ–°æ³•ä»¤: ${UPDATED_LAWS} ä»¶

          è‡ªå‹•æ›´æ–° by GitHub Actions"

          git push

      - name: Create GitHub Issues for bills (Diet Tracking)
        run: |
          echo "Creating/Updating GitHub Issues for Diet bills..."
          node --loader ts-node/esm create_bill_issues.ts
        working-directory: scripts
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          # USE_LLM_SUMMARY: 'true'  # LLMè¦ç´„ã‚’æœ‰åŠ¹åŒ–ï¼ˆæ™‚é–“ãŒã‹ã‹ã‚‹ãŸã‚é€šå¸¸ã¯ç„¡åŠ¹ï¼‰
          NODE_OPTIONS: '--max-old-space-size=4096 --no-warnings'
          ISSUES_NUM_SESSIONS: '10'
          ISSUES_MAX_CREATE: '10000'
        continue-on-error: true

      - name: Commit issue tracking file
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          if [ -f data/index/legislators/created_issues.json ]; then
            git add data/index/legislators/created_issues.json
            git add data/index/legislators/legislator_bills.json 2>/dev/null || true
            git add data/index/legislators/pending_summaries.json 2>/dev/null || true
            if ! git diff --staged --quiet; then
              git commit -m "ðŸ“‹ å›½ä¼šè¿½è·¡ãƒ‡ãƒ¼ã‚¿æ›´æ–°

              - æ³•æ¡ˆIssueè‡ªå‹•ä½œæˆ/æ›´æ–°
              - è­°å“¡åˆ¥æ³•æ¡ˆãƒ‡ãƒ¼ã‚¿æ›´æ–°
              - LLMè¦ç´„ã‚­ãƒ¥ãƒ¼æ›´æ–°

              è‡ªå‹•æ›´æ–° by GitHub Actions"
              git push
            fi
          fi
        continue-on-error: true

      - name: Summary
        run: |
          echo "## Update Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Date**: $(date +%Y-%m-%d)" >> $GITHUB_STEP_SUMMARY
          echo "- **Changes**: ${{ steps.check_changes.outputs.has_changes }}" >> $GITHUB_STEP_SUMMARY

          if [ -f data/index/laws.json ]; then
            TOTAL=$(cat data/index/laws.json | grep -c '"id"' || echo "unknown")
            echo "- **Total laws**: ${TOTAL}" >> $GITHUB_STEP_SUMMARY
          fi

          if [ -f data/index/legislators/legislators.json ]; then
            LEGISLATORS=$(cat data/index/legislators/legislators.json | grep -c '"id"' || echo "unknown")
            echo "- **Total legislators**: ${LEGISLATORS}" >> $GITHUB_STEP_SUMMARY
          fi

          if [ -f data/index/legislators/smri_bills.json ]; then
            BILLS=$(cat data/index/legislators/smri_bills.json | grep '"total_count"' | grep -oE '[0-9]+' || echo "unknown")
            echo "- **Total bills**: ${BILLS}" >> $GITHUB_STEP_SUMMARY
          fi

          if [ -f data/index/legislators/created_issues.json ]; then
            ISSUES=$(cat data/index/legislators/created_issues.json | grep -c '"bill_' || echo "0")
            echo "- **GitHub Issues**: ${ISSUES}" >> $GITHUB_STEP_SUMMARY
          fi
