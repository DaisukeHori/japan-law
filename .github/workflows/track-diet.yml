name: Track National Diet

on:
  schedule:
    # æ¯Žæ—¥åˆå‰9æ™‚ï¼ˆJSTï¼‰ã«å®Ÿè¡Œ
    - cron: '0 0 * * *'
  workflow_dispatch:
    inputs:
      num_sessions:
        description: 'Number of Diet sessions to track'
        required: false
        default: '10'
        type: string

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  track:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci
        working-directory: scripts

      - name: Fetch latest Diet data
        run: |
          echo "Fetching latest Diet data from APIs..."
          node --loader ts-node/esm auto_update.ts
        working-directory: scripts
        env:
          NODE_OPTIONS: '--max-old-space-size=4096 --no-warnings'

      - name: Create/Update GitHub Issues for Diet bills
        run: |
          echo "Syncing GitHub Issues with Diet bills..."
          node --loader ts-node/esm create_bill_issues.ts
        working-directory: scripts
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          NODE_OPTIONS: '--max-old-space-size=4096 --no-warnings'
          ISSUES_NUM_SESSIONS: ${{ inputs.num_sessions || '10' }}
          # ISSUES_MAX_CREATE: æŒ‡å®šãªã— = ç„¡åˆ¶é™

      - name: Create PRs for enacted bills
        run: |
          echo "Creating PRs for enacted bills..."
          node --loader ts-node/esm create_enactment_prs.ts
        working-directory: scripts
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          NODE_OPTIONS: '--max-old-space-size=4096 --no-warnings'
          PRS_MAX_CREATE: '10'
        continue-on-error: true

      - name: Commit tracking data
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # æ˜Žç¤ºçš„ã«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¿½åŠ ï¼ˆpending_summaries.json, legislator_speeches.jsonã‚‚å«ã‚€ï¼‰
          git add data/index/legislators/legislators.json 2>/dev/null || true
          git add data/index/legislators/smri_bills.json 2>/dev/null || true
          git add data/index/legislators/created_issues.json 2>/dev/null || true
          git add data/index/legislators/created_prs.json 2>/dev/null || true
          git add data/index/legislators/legislator_bills.json 2>/dev/null || true
          git add data/index/legislators/pending_summaries.json 2>/dev/null || true
          git add data/index/legislators/legislator_speeches.json 2>/dev/null || true

          if ! git diff --staged --quiet; then
            DATE=$(date +%Y-%m-%d)
            git commit -m "ðŸ›ï¸ å›½ä¼šè¿½è·¡ãƒ‡ãƒ¼ã‚¿æ›´æ–°: ${DATE}

            - è­°å“¡ãƒ‡ãƒ¼ã‚¿æ›´æ–°ï¼ˆå›½ä¼šä¼šè­°éŒ²APIï¼‰
            - æ³•æ¡ˆãƒ‡ãƒ¼ã‚¿æ›´æ–°ï¼ˆSMRIï¼‰
            - GitHub IssuesåŒæœŸ
            - æˆç«‹æ³•æ¡ˆPRä½œæˆ
            - LLMè¦ç´„ã‚­ãƒ¥ãƒ¼æ›´æ–°

            è‡ªå‹•æ›´æ–° by GitHub Actions"
            git pull --rebase origin main || true
            git push
          else
            echo "No changes to commit"
          fi

      - name: Summary
        run: |
          echo "## Diet Tracking Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Date**: $(date +%Y-%m-%d)" >> $GITHUB_STEP_SUMMARY

          if [ -f data/index/legislators/legislators.json ]; then
            LEGISLATORS=$(cat data/index/legislators/legislators.json | grep '"active_count"' | grep -oE '[0-9]+' || echo "unknown")
            echo "- **Active Legislators**: ${LEGISLATORS}" >> $GITHUB_STEP_SUMMARY
          fi

          if [ -f data/index/legislators/smri_bills.json ]; then
            BILLS=$(cat data/index/legislators/smri_bills.json | grep '"total_count"' | grep -oE '[0-9]+' || echo "unknown")
            PASSED=$(cat data/index/legislators/smri_bills.json | grep '"passed_count"' | grep -oE '[0-9]+' || echo "unknown")
            echo "- **Total Bills**: ${BILLS} (Passed: ${PASSED})" >> $GITHUB_STEP_SUMMARY
          fi

          if [ -f data/index/legislators/created_issues.json ]; then
            ISSUES=$(cat data/index/legislators/created_issues.json | grep -c '"bill_' || echo "0")
            echo "- **GitHub Issues**: ${ISSUES}" >> $GITHUB_STEP_SUMMARY
          fi

          if [ -f data/index/legislators/legislator_bills.json ]; then
            PROPOSERS=$(cat data/index/legislators/legislator_bills.json | grep '"total_proposers"' | grep -oE '[0-9]+' || echo "unknown")
            echo "- **Tracked Proposers**: ${PROPOSERS}" >> $GITHUB_STEP_SUMMARY
          fi

          if [ -f data/index/legislators/pending_summaries.json ]; then
            PENDING=$(cat data/index/legislators/pending_summaries.json | grep -c '"comment_id"' || echo "0")
            echo "- **Pending LLM Summaries**: ${PENDING}" >> $GITHUB_STEP_SUMMARY
          fi

          if [ -f data/index/legislators/legislator_speeches.json ]; then
            SPEAKERS=$(cat data/index/legislators/legislator_speeches.json | grep '"total_legislators"' | grep -oE '[0-9]+' || echo "0")
            SPEECHES=$(cat data/index/legislators/legislator_speeches.json | grep '"total_speeches"' | grep -oE '[0-9]+' || echo "0")
            echo "- **Tracked Speakers**: ${SPEAKERS} (${SPEECHES} speeches)" >> $GITHUB_STEP_SUMMARY
          fi
